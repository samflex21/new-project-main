{% extends "base.html" %}
{% from "components/cards.html" import stat_card, progress_card %}
{% from "components/chart_panels.html" import bar_chart_panel, pie_chart_panel, line_chart_panel, heatmap_panel %}
{% from "components/filters.html" import department_filter, time_period_filter, demographic_filter %}

{% block title %}Population Health Insights - Heart Risk Monitor{% endblock %}

{% block page_title %}Population Health Insights{% endblock %}

{% block sidebar_filters %}
<div class="filter-section">
    <h5><i class="fas fa-filter me-2"></i>Population Filters</h5>
    
    <!-- Department Filter -->
    <div class="mb-4">
        <h6 class="mb-3">Department</h6>
        {{ department_filter() }}
    </div>
    
    <!-- Time Period Filter -->
    <div class="mb-4">
        <h6 class="mb-3">Time Period</h6>
        {{ time_period_filter() }}
    </div>
    
    <!-- Demographics Filter -->
    <div class="mb-4">
        <h6 class="mb-3">Demographics</h6>
        {{ demographic_filter() }}
    </div>
    
    <div class="d-grid gap-2 mt-4">
        <button class="btn btn-light" id="apply-filters">
            <i class="fas fa-check me-2"></i>Apply Filters
        </button>
        <button class="btn btn-outline-light" id="reset-filters">
            <i class="fas fa-undo me-2"></i>Reset Filters
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        {{ stat_card('Total Patients', '124', 'fas fa-users', 'primary') }}
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        {{ stat_card('Average Age', '48.7', 'fas fa-calendar', 'info') }}
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        {{ stat_card('High Risk %', '22.6%', 'fas fa-exclamation-triangle', 'danger') }}
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        {{ progress_card('Risk Assessment', '124', '150', 'primary') }}
    </div>
</div>
        
        <!-- Risk Distribution and Age-Risk Distribution Row -->
        <div class="row">
            <div class="col-xl-5 mb-4">
                {{ pie_chart_panel('Population Heart Risk Distribution', 'populationRiskChart', 
                   'Distribution of patients by risk level across the population.') }}
            </div>
            <div class="col-xl-7 mb-4">
                {{ bar_chart_panel('Age-Risk Distribution', 'ageRiskChart', 
                   'Distribution of risk levels across different age groups.') }}
            </div>
        </div>
        
        <!-- Trend Analysis and Geographic Distribution Row -->
        <div class="row">
            <div class="col-xl-8 mb-4">
                {{ line_chart_panel('Risk Trend Analysis', 'riskTrendChart',
                   'Monthly trend of risk levels over time.') }}
            </div>
            <div class="col-xl-4 mb-4">
                {{ pie_chart_panel('Gender Distribution', 'genderChart',
                   'Distribution of patients by gender.') }}
            </div>
        </div>
        
        <!-- Lifestyle Impact and Correlation Matrix Row -->
        <div class="row">
            <div class="col-xl-6 mb-4">
                {{ bar_chart_panel('Lifestyle Impact Analysis', 'lifestyleChart',
                   'Impact of lifestyle factors on risk levels.') }}
            </div>
            <div class="col-xl-6 mb-4">
                {{ heatmap_panel('Risk Factor Correlation', 'correlationChart',
                   'Correlation between different risk factors.') }}
            </div>
        </div>
        
        <!-- Risk Factors Table -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Key Risk Factors</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#" onclick="exportTableToCSV('riskFactorsTable', 'risk_factors.csv'); return false;">
                            <i class="fas fa-download fa-sm fa-fw me-2 text-gray-400"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="riskFactorsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Risk Factor</th>
                                <th>High Risk Count</th>
                                <th>Medium Risk Count</th>
                                <th>Low Risk Count</th>
                                <th>Impact Score</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- This will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
<script>
    // Sample data from the server
    var sampleData = {% if sample_data %}{{ sample_data|tojson|safe }}{% else %}null{% endif %};
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize charts
        initializeManagerialDashboard();
        
        // Set up filter events
        document.getElementById('apply-department-filter').addEventListener('click', fetchDashboardData);
        document.getElementById('apply-time-period-filter').addEventListener('click', fetchDashboardData);
        document.getElementById('apply-demographic-filter').addEventListener('click', fetchDashboardData);
        document.getElementById('refresh-data').addEventListener('click', fetchDashboardData);
        
        // Initial data fetch
        fetchDashboardData();
    });
    
    function initializeManagerialDashboard() {
        // Initialize empty charts (will be populated with data later)
        // Population Risk Distribution Pie Chart
        const riskCtx = document.getElementById('populationRiskChart').getContext('2d');
        window.populationRiskChart = new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        '#4cc9f0', // Medical blue for low risk
                        '#7209b7', // Medical purple for medium risk
                        '#f72585'  // Medical pink/red for high risk
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverBackgroundColor: [
                        '#3db5db', // Slightly darker on hover
                        '#6508a3', 
                        '#e01e75'
                    ],
                    hoverBorderColor: '#ffffff',
                    hoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                radius: '90%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                family: 'Poppins, sans-serif',
                                size: 12,
                                weight: 'bold'
                            },
                            padding: 15,
                            usePointStyle: true,
                            boxWidth: 8
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#333',
                        bodyFont: {
                            family: 'Poppins, sans-serif'
                        },
                        borderColor: '#ddd',
                        borderWidth: 1,
                        displayColors: true,
                        boxPadding: 8,
                        cornerRadius: 6
                    }
                }
            }
        });
        
        // Age-Risk Distribution Bar Chart
        const ageRiskCtx = document.getElementById('ageRiskChart').getContext('2d');
        window.ageRiskChart = new Chart(ageRiskCtx, {
            type: 'bar',
            data: {
                labels: ['18-29', '30-44', '45-59', '60+'],
                datasets: [
                    {
                        label: 'High Risk',
                        data: [0, 0, 0, 0],
                        backgroundColor: '#e74a3b'
                    },
                    {
                        label: 'Medium Risk',
                        data: [0, 0, 0, 0],
                        backgroundColor: '#f6c23e'
                    },
                    {
                        label: 'Low Risk',
                        data: [0, 0, 0, 0],
                        backgroundColor: '#1cc88a'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Risk Trend Analysis Line Chart
        const trendCtx = document.getElementById('riskTrendChart').getContext('2d');
        window.riskTrendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'High Risk',
                        data: [],
                        borderColor: '#e74a3b',
                        backgroundColor: 'rgba(231, 74, 59, 0.05)',
                        tension: 0.1
                    },
                    {
                        label: 'Medium Risk',
                        data: [],
                        borderColor: '#f6c23e',
                        backgroundColor: 'rgba(246, 194, 62, 0.05)',
                        tension: 0.1
                    },
                    {
                        label: 'Low Risk',
                        data: [],
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.05)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Gender Distribution Pie Chart
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        window.genderChart = new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#4e73df', '#36b9cc']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Lifestyle Impact Bar Chart
        const lifestyleCtx = document.getElementById('lifestyleChart').getContext('2d');
        window.lifestyleChart = new Chart(lifestyleCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'High Risk',
                    data: [],
                    backgroundColor: '#e74a3b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Initialize D3.js for the correlation heatmap
        initializeCorrelationHeatmap();
    }
    
    function initializeCorrelationHeatmap() {
        // D3.js correlation heatmap setup
        const margin = {top: 30, right: 30, bottom: 70, left: 70};
        const width = 450 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;
        
        // Append SVG object to the div
        const svg = d3.select("#correlationChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
            
        // Initial empty visualization
        const factors = ['BMI', 'Blood Pressure', 'Cholesterol', 'Blood Sugar', 'Age'];
        const data = [];
        
        for (let i = 0; i < factors.length; i++) {
            for (let j = 0; j < factors.length; j++) {
                data.push({
                    x: factors[i],
                    y: factors[j],
                    value: 0
                });
            }
        }
        
        // Build X scales and axis
        const x = d3.scaleBand()
            .range([0, width])
            .domain(factors)
            .padding(0.01);
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");
            
        // Build Y scales and axis
        const y = d3.scaleBand()
            .range([height, 0])
            .domain(factors)
            .padding(0.01);
        svg.append("g")
            .call(d3.axisLeft(y));
            
        // Build color scale
        const colorScale = d3.scaleLinear()
            .range(["white", "#4e73df"])
            .domain([0, 1]);
            
        // Create initial empty rectangles
        svg.selectAll()
            .data(data)
            .join("rect")
            .attr("x", d => x(d.x))
            .attr("y", d => y(d.y))
            .attr("width", x.bandwidth())
            .attr("height", y.bandwidth())
            .style("fill", d => colorScale(d.value));
            
        // Store the scales for later updates
        window.correlationScales = {
            x: x,
            y: y,
            color: colorScale,
            svg: svg
        };
    }
    
    function fetchDashboardData() {
        // Get filter values
        const department = document.getElementById('department-select').value;
        const timePeriod = document.getElementById('time-period-select').value;
        const demographic = document.getElementById('demographic-select').value;
        
        // Check if we have sample data passed from the server
        if (sampleData) {
            // Use the sample data provided by the route
            updateDashboardData(sampleData);
            return;
        }
        
        // Build query parameters
        const params = new URLSearchParams();
        if (department) params.append('department', department);
        if (timePeriod) params.append('time_period', timePeriod);
        if (demographic) params.append('demographic', demographic);
        
        // For demonstration purposes, use mock data
        const mockData = getMockManagerialData();
        updateDashboardData(mockData);
        
        /* Uncomment for real API call
        fetch(`/managerial/data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                updateDashboardData(data);
            })
            .catch(error => {
                console.error('Error fetching dashboard data:', error);
                // Show error message to user
                alert('Error fetching dashboard data. Please try again.');
            });
        */
    }
    
    function updateDashboardData(data) {
        // Update population risk distribution chart
        const riskCounts = {'low': 0, 'medium': 0, 'high': 0};
        
        if (data.population_data && data.population_data.gender_risk) {
            for (const item of data.population_data.gender_risk) {
                const riskLevel = item.risk_level.toLowerCase();
                if (riskCounts.hasOwnProperty(riskLevel)) {
                    riskCounts[riskLevel] += item.count;
                }
            }
        }
        
        window.populationRiskChart.data.datasets[0].data = [
            riskCounts.low,
            riskCounts.medium,
            riskCounts.high
        ];
        window.populationRiskChart.update();
        
        // Update age-risk distribution chart
        if (data.population_data && data.population_data.age_distribution) {
            const ageGroups = [];
            const highRiskData = [];
            const mediumRiskData = [];
            const lowRiskData = [];
            
            // Process age distribution data
            // This is simplified - in a real application, you would have age-risk combined data
            for (const item of data.population_data.age_distribution) {
                ageGroups.push(item.age_group);
                
                // Mock distribution by risk level for demo
                const total = item.count;
                highRiskData.push(Math.round(total * 0.2));  // 20% high risk
                mediumRiskData.push(Math.round(total * 0.3));  // 30% medium risk
                lowRiskData.push(Math.round(total * 0.5));  // 50% low risk
            }
            
            window.ageRiskChart.data.labels = ageGroups;
            window.ageRiskChart.data.datasets[0].data = highRiskData;
            window.ageRiskChart.data.datasets[1].data = mediumRiskData;
            window.ageRiskChart.data.datasets[2].data = lowRiskData;
            window.ageRiskChart.update();
        }
        
        // Update risk trend chart
        if (data.metrics && data.metrics.trend_analysis) {
            const months = [];
            const highRiskTrend = [];
            const mediumRiskTrend = [];
            const lowRiskTrend = [];
            
            for (const item of data.metrics.trend_analysis) {
                months.push(item.month);
                highRiskTrend.push(item.high_risk);
                mediumRiskTrend.push(item.medium_risk);
                lowRiskTrend.push(item.low_risk);
            }
            
            window.riskTrendChart.data.labels = months;
            window.riskTrendChart.data.datasets[0].data = highRiskTrend;
            window.riskTrendChart.data.datasets[1].data = mediumRiskTrend;
            window.riskTrendChart.data.datasets[2].data = lowRiskTrend;
            window.riskTrendChart.update();
        }
        
        // Update gender distribution chart
        const genderCounts = {'Male': 0, 'Female': 0};
        
        if (data.population_data && data.population_data.gender_risk) {
            for (const item of data.population_data.gender_risk) {
                if (genderCounts.hasOwnProperty(item.gender)) {
                    genderCounts[item.gender] += item.count;
                }
            }
        }
        
        window.genderChart.data.datasets[0].data = [
            genderCounts['Male'],
            genderCounts['Female']
        ];
        window.genderChart.update();
        
        // Update lifestyle impact chart
        if (data.population_data && data.population_data.lifestyle_impact) {
            const lifestyleFactors = [];
            const lifestyleImpacts = [];
            
            // Process lifestyle data
            const processed = {};
            
            for (const item of data.population_data.lifestyle_impact) {
                // Create a lifestyle factor label
                const factor = `${item.smoking ? 'Smoking' : 'Non-Smoking'}, ${item.alcohol ? 'Alcohol' : 'No Alcohol'}`;
                
                if (!processed[factor]) {
                    processed[factor] = {
                        highCount: 0,
                        totalCount: 0
                    };
                }
                
                processed[factor].totalCount += item.count;
                if (item.risk_level.toLowerCase() === 'high') {
                    processed[factor].highCount += item.count;
                }
            }
            
            // Calculate impact as percentage of high risk
            for (const [factor, counts] of Object.entries(processed)) {
                lifestyleFactors.push(factor);
                lifestyleImpacts.push(Math.round((counts.highCount / counts.totalCount) * 100));
            }
            
            window.lifestyleChart.data.labels = lifestyleFactors;
            window.lifestyleChart.data.datasets[0].data = lifestyleImpacts;
            window.lifestyleChart.update();
        }
        
        // Update correlation heatmap
        updateCorrelationHeatmap();
        
        // Update risk factors table
        updateRiskFactorsTable();
    }
    
    function updateCorrelationHeatmap() {
        // This would normally use real correlation data from the API
        // For demonstration, we'll use mock correlation data
        const factors = ['BMI', 'Blood Pressure', 'Cholesterol', 'Blood Sugar', 'Age'];
        const correlationData = [];
        
        // Mock correlation matrix (symmetric)
        const matrix = [
            [1.0, 0.7, 0.6, 0.5, 0.4],
            [0.7, 1.0, 0.6, 0.5, 0.3],
            [0.6, 0.6, 1.0, 0.8, 0.5],
            [0.5, 0.5, 0.8, 1.0, 0.4],
            [0.4, 0.3, 0.5, 0.4, 1.0]
        ];
        
        for (let i = 0; i < factors.length; i++) {
            for (let j = 0; j < factors.length; j++) {
                correlationData.push({
                    x: factors[i],
                    y: factors[j],
                    value: matrix[i][j]
                });
            }
        }
        
        // Update the heatmap
        const scales = window.correlationScales;
        scales.svg.selectAll("rect")
            .data(correlationData)
            .transition()
            .duration(500)
            .style("fill", d => scales.color(d.value));
    }
    
    function updateRiskFactorsTable() {
        // This would normally use real risk factor data from the API
        // For demonstration, we'll use mock risk factor data
        const riskFactors = [
            {
                factor: 'Hypertension',
                high_count: 25,
                medium_count: 30,
                low_count: 15,
                impact_score: 0.8,
                trend: 'up'
            },
            {
                factor: 'High Cholesterol',
                high_count: 22,
                medium_count: 35,
                low_count: 18,
                impact_score: 0.75,
                trend: 'up'
            },
            {
                factor: 'Diabetes',
                high_count: 18,
                medium_count: 20,
                low_count: 10,
                impact_score: 0.7,
                trend: 'stable'
            },
            {
                factor: 'Obesity',
                high_count: 20,
                medium_count: 25,
                low_count: 15,
                impact_score: 0.65,
                trend: 'up'
            },
            {
                factor: 'Smoking',
                high_count: 15,
                medium_count: 20,
                low_count: 10,
                impact_score: 0.6,
                trend: 'down'
            },
            {
                factor: 'Sedentary Lifestyle',
                high_count: 18,
                medium_count: 30,
                low_count: 25,
                impact_score: 0.55,
                trend: 'stable'
            }
        ];
        
        const tableBody = document.querySelector('#riskFactorsTable tbody');
        tableBody.innerHTML = '';
        
        for (const factor of riskFactors) {
            const row = document.createElement('tr');
            
            // Determine trend icon
            let trendIcon = '';
            let trendClass = '';
            
            if (factor.trend === 'up') {
                trendIcon = 'fa-arrow-up';
                trendClass = 'text-danger';
            } else if (factor.trend === 'down') {
                trendIcon = 'fa-arrow-down';
                trendClass = 'text-success';
            } else {
                trendIcon = 'fa-equals';
                trendClass = 'text-muted';
            }
            
            row.innerHTML = `
                <td>${factor.factor}</td>
                <td>${factor.high_count}</td>
                <td>${factor.medium_count}</td>
                <td>${factor.low_count}</td>
                <td>${factor.impact_score.toFixed(2)}</td>
                <td><i class="fas ${trendIcon} ${trendClass}"></i></td>
            `;
            
            tableBody.appendChild(row);
        }
    }
    
    function exportTableToCSV(tableId, filename) {
        const table = document.getElementById(tableId);
        let csv = [];
        
        // Get header row
        const headerRow = [];
        const headers = table.querySelectorAll('thead th');
        for (const header of headers) {
            headerRow.push(header.textContent);
        }
        csv.push(headerRow.join(','));
        
        // Get data rows
        const rows = table.querySelectorAll('tbody tr');
        for (const row of rows) {
            const rowData = [];
            const cols = row.querySelectorAll('td');
            
            for (const col of cols) {
                // Remove any commas and get text content
                rowData.push('"' + col.textContent.replace(/"/g, '""') + '"');
            }
            
            csv.push(rowData.join(','));
        }
        
        // Download CSV file
        const csvString = csv.join('\n');
        const link = document.createElement('a');
        link.style.display = 'none';
        link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Mock data generator function (for demonstration)
    function getMockManagerialData() {
        return {
            population_data: {
                age_distribution: [
                    { age_group: '18-29', count: 20, avg_bmi: 24.5, avg_systolic: 118 },
                    { age_group: '30-44', count: 35, avg_bmi: 26.8, avg_systolic: 125 },
                    { age_group: '45-59', count: 42, avg_bmi: 28.3, avg_systolic: 135 },
                    { age_group: '60+', count: 27, avg_bmi: 29.2, avg_systolic: 142 }
                ],
                gender_risk: [
                    { gender: 'Male', risk_level: 'High', count: 18 },
                    { gender: 'Male', risk_level: 'Medium', count: 25 },
                    { gender: 'Male', risk_level: 'Low', count: 32 },
                    { gender: 'Female', risk_level: 'High', count: 10 },
                    { gender: 'Female', risk_level: 'Medium', count: 17 },
                    { gender: 'Female', risk_level: 'Low', count: 22 }
                ],
                lifestyle_impact: [
                    { smoking: true, alcohol: true, risk_level: 'High', count: 15 },
                    { smoking: true, alcohol: false, risk_level: 'High', count: 8 },
                    { smoking: false, alcohol: true, risk_level: 'High', count: 5 },
                    { smoking: false, alcohol: false, risk_level: 'High', count: 0 },
                    { smoking: true, alcohol: true, risk_level: 'Medium', count: 10 },
                    { smoking: true, alcohol: false, risk_level: 'Medium', count: 12 },
                    { smoking: false, alcohol: true, risk_level: 'Medium', count: 15 },
                    { smoking: false, alcohol: false, risk_level: 'Medium', count: 5 },
                    { smoking: true, alcohol: true, risk_level: 'Low', count: 5 },
                    { smoking: true, alcohol: false, risk_level: 'Low', count: 10 },
                    { smoking: false, alcohol: true, risk_level: 'Low', count: 15 },
                    { smoking: false, alcohol: false, risk_level: 'Low', count: 24 }
                ]
            },
            metrics: {
                trend_analysis: [
                    { month: 'Jan', high_risk: 25, medium_risk: 40, low_risk: 60 },
                    { month: 'Feb', high_risk: 22, medium_risk: 42, low_risk: 58 },
                    { month: 'Mar', high_risk: 28, medium_risk: 38, low_risk: 56 },
                    { month: 'Apr', high_risk: 26, medium_risk: 40, low_risk: 54 },
                    { month: 'May', high_risk: 30, medium_risk: 42, low_risk: 52 },
                    { month: 'Jun', high_risk: 28, medium_risk: 44, low_risk: 50 }
                ],
                demographic_breakdown: [
                    { gender: 'Male', count: 75, avg_risk_score: 2.1 },
                    { gender: 'Female', count: 49, avg_risk_score: 1.8 }
                ],
                lifestyle_impact: [
                    { factor: 'Smoking', impact_score: 0.72 },
                    { factor: 'Alcohol', impact_score: 0.58 },
                    { factor: 'Exercise', impact_score: 0.63 },
                    { factor: 'Diet', impact_score: 0.68 }
                ]
            }
        };
    }
</script>
{% endblock %}
