{% extends "base.html" %}
{% from "components/cards.html" import stat_card, risk_card %}
{% from "components/chart_panels.html" import line_chart_panel, bar_chart_panel, radar_chart_panel, pie_chart_panel %}
{% from "components/filters.html" import date_range_filter, risk_level_filter, patient_search %}

{% block title %}Patient Risk Monitoring - Heart Risk Monitor{% endblock %}

{% block page_title %}Patient Risk Monitoring{% endblock %}

{% block sidebar_filters %}
<div class="filter-section">
    <h5><i class="fas fa-filter me-2"></i>Filters</h5>
    
    <!-- Date Range Filter -->
    <div class="mb-4">
        <h6 class="mb-3">Date Range</h6>
        {{ date_range_filter() }}
    </div>
    
    <!-- Risk Level Filter -->
    <div class="mb-4">
        <h6 class="mb-3">Risk Level</h6>
        {{ risk_level_filter() }}
    </div>
    
    <!-- Patient Search -->
    <div class="mb-4">
        <h6 class="mb-3">Patient Search</h6>
        {{ patient_search() }}
    </div>
    
    <div class="d-grid gap-2 mt-4">
        <button class="btn btn-light" id="apply-filters">
            <i class="fas fa-check me-2"></i>Apply Filters
        </button>
        <button class="btn btn-outline-light" id="reset-filters">
            <i class="fas fa-undo me-2"></i>Reset Filters
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- No SVG gradient definitions needed with direct colors -->

<!-- Metrics and Video Row -->
<div class="row mb-4">
    <!-- Video Section (left 40%) -->
    <div class="col-md-4 mb-4">
        <div class="card shadow h-100">
            <div class="card-body p-0 d-flex justify-content-center align-items-center" style="height: 220px; overflow: hidden;">
                <video style="height: 100%; width: 100%; object-fit: contain;" autoplay loop muted playsinline>
                    <source src="{{ url_for('static', filename='videos/videoplayback.mp4') }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>
    
    <!-- Metrics Cards Section (right 60%) -->
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">TOTAL PATIENTS</div>
                        <div class="chart-container" style="position: relative; height: 120px; width: 120px; margin: 0 auto;">
                            <canvas id="totalPatientsChart" width="120" height="120"></canvas>
                            <div class="chart-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #4361ee;">
                                <i class="fas fa-user fa-2x"></i>
                            </div>
                        </div>
                        <div class="h3 mb-0 font-weight-bold text-gray-800 text-center mt-3">5,443</div>
                        <div class="text-success text-center"><i class="fas fa-arrow-up"></i> 50% since yesterday</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">HIGH RISK PATIENTS</div>
                        <div class="chart-container" style="position: relative; height: 120px; width: 120px; margin: 0 auto;">
                            <canvas id="highRiskChart" width="120" height="120"></canvas>
                            <div class="chart-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444;">
                                <i class="fas fa-heartbeat fa-2x"></i>
                            </div>
                        </div>
                        <div class="h3 mb-0 font-weight-bold text-gray-800 text-center mt-3">756</div>
                        <div class="text-danger text-center"><i class="fas fa-arrow-down"></i> 35% since yesterday</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">MEDIUM RISK PATIENTS</div>
                        <div class="chart-container" style="position: relative; height: 120px; width: 120px; margin: 0 auto;">
                            <canvas id="mediumRiskChart" width="120" height="120"></canvas>
                            <div class="chart-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #f59e0b;">
                                <i class="fas fa-bolt fa-2x"></i>
                            </div>
                        </div>
                        <div class="h3 mb-0 font-weight-bold text-gray-800 text-center mt-3">1,238</div>
                        <div class="text-success text-center"><i class="fas fa-arrow-up"></i> 12% since yesterday</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">LOW RISK PATIENTS</div>
                        <div class="chart-container" style="position: relative; height: 120px; width: 120px; margin: 0 auto;">
                            <canvas id="lowRiskChart" width="120" height="120"></canvas>
                            <div class="chart-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #10b981;">
                                <i class="fas fa-heart fa-2x"></i>
                            </div>
                        </div>
                        <div class="h3 mb-0 font-weight-bold text-gray-800 text-center mt-3">3,449</div>
                        <div class="text-success text-center"><i class="fas fa-arrow-up"></i> 27% since yesterday</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        
        <!-- Risk Distribution and Vital Signs Row -->
        <div class="row">
            <div class="col-xl-4 mb-4">
                {{ pie_chart_panel('Heart Risk Distribution', 'riskDistributionChart', 
                   'Distribution of patients by heart attack risk level.') }}
            </div>
            <div class="col-xl-8 mb-4">
                {{ line_chart_panel('Vital Signs Timeline', 'vitalSignsChart', 
                   'Trends of key vital signs over time.') }}
            </div>
        </div>
        
        <!-- Lab Results and Risk Score Row -->
        <div class="row">
            <div class="col-xl-6 mb-4">
                {{ radar_chart_panel('Lab Results Analysis', 'labResultsChart',
                   'Comparison of lab results against normal ranges.') }}
            </div>
            <div class="col-xl-6 mb-4">
                {{ bar_chart_panel('Patient Metrics Comparison', 'patientComparisonChart',
                   'Comparison of patient metrics against population averages.') }}
            </div>
        </div>
        
        <!-- High Risk Patients Table -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-white">High Risk Patients</h6>
                <a href="/analytical/patients?view=all" class="btn btn-sm btn-primary">
                    View All
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="highRiskTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Risk Level</th>
                                <th>Key Factors</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if high_risk_patients %}
                                {% for patient in high_risk_patients[:10] %}
                                    <tr>
                                        <td>{{ patient.patient_id }}</td>
                                        <td>{{ patient.age }}</td>
                                        <td>{{ patient.gender }}</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                        <td>
                                            <!-- Build risk factors list using individual variables -->
                                            {% set has_high_cholesterol = patient.Cholesterol > 200 %}
                                            {% set has_high_bp = patient.SystolicBP > 140 %}
                                            {% set has_high_bmi = patient.BMI > 30 %}
                                            
                                            {% if has_high_cholesterol %}High Cholesterol{% endif %}
                                            {% if has_high_bp %}{% if has_high_cholesterol %}, {% endif %}High BP{% endif %}
                                            {% if has_high_bmi %}{% if has_high_cholesterol or has_high_bp %}, {% endif %}High BMI{% endif %}
                                            
                                            {% if not (has_high_cholesterol or has_high_bp or has_high_bmi) %}
                                                Multiple Risk Factors
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="/patients/{{ patient.patient_id }}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-user"></i>
                                            </a>
                                            <a href="/patients/report/{{ patient.patient_id }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-file-medical"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No high-risk patients found</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
<!-- Data from server rendered as JavaScript variables -->
<script type="text/javascript">
    // Create a global data object to store server-provided data
    window.serverData = {};
    
    // Set sample data from server
    {% if sample_data %}
        window.serverData.sampleData = {{ sample_data|tojson|safe }};
    {% else %}
        window.serverData.sampleData = {};
    {% endif %}
</script>

<!-- Main application JavaScript -->
<script type="text/javascript">
    // Reference server data from the global object
    var dashboardData = null;
    var sampleData = window.serverData.sampleData;

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize charts
        initializeAnalyticalDashboard();
        
        // Initialize circular indicators
        initializeCircularCharts();
        
        // Set up filter events
        // Add event listeners safely (with null checks)
        const dateRangeSelect = document.getElementById('date-range-select');
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', function() {
                const customDateRange = document.getElementById('custom-date-range');
                if (customDateRange) {
                    if (this.value === 'custom') {
                        customDateRange.classList.remove('d-none');
                    } else {
                        customDateRange.classList.add('d-none');
                    }
                }
            });
        }
        
        // Add safe event listeners to buttons
        const applyDateFilterBtn = document.getElementById('apply-date-filter');
        if (applyDateFilterBtn) {
            applyDateFilterBtn.addEventListener('click', fetchDashboardData);
        }
        
        // Add event listener for View All high risk patients button
        const viewAllHighRiskBtn = document.getElementById('view-all-high-risk');
        if (viewAllHighRiskBtn) {
            viewAllHighRiskBtn.addEventListener('click', function() {
                // Fetch all high risk patients and display them
                fetchHighRiskPatients().then(patients => {
                    if (patients && Array.isArray(patients)) {
                        // Show all patients instead of just the first 10
                        updateHighRiskTable(patients, true);
                    }
                });
            });
        }
        
        const applyRiskFilterBtn = document.getElementById('apply-risk-filter');
        if (applyRiskFilterBtn) {
            applyRiskFilterBtn.addEventListener('click', fetchDashboardData);
        }
        
        const searchBtn = document.getElementById('search-btn');
        if (searchBtn) {
            searchBtn.addEventListener('click', searchPatient);
        }
        
        const refreshDataBtn = document.getElementById('refresh-data');
        if (refreshDataBtn) {
            refreshDataBtn.addEventListener('click', fetchDashboardData);
        }
        
        // Initial data fetch for dashboard charts
        fetchDashboardData();
        
        // Force a direct manual test of the high risk patients table with real data
        console.log('Directly testing high risk patients table with sample data...');
        
        // Make a direct API call to fetch high risk patients
        fetch('/analytical/patients?risk_level=High%20Risk')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                return response.json();
            })
            .then(patients => {
                console.log('API directly returned', patients.length, 'high risk patients');
                
                if (patients && patients.length > 0) {
                    console.log('First patient from API:', patients[0]);
                    
                    // Force update the table with this data
                    const tableBody = document.querySelector('#highRiskTable tbody');
                    tableBody.innerHTML = '';
                    
                    // Take the first 10 patients
                    const patientsToShow = patients.slice(0, 10);
                    
                    // Manually create rows for each patient
                    patientsToShow.forEach(patient => {
                        const row = document.createElement('tr');
                        
                        // Get basic patient info
                        const patientId = patient.patient_id;
                        const patientAge = patient.age;
                        const patientGender = patient.gender;
                        
                        // Create key factors string
                        let keyFactors = [];
                        if (patient.Cholesterol > 200) keyFactors.push('High Cholesterol');
                        if (patient.SystolicBP > 140) keyFactors.push('High BP');
                        if (patient.BMI > 30) keyFactors.push('High BMI');
                        if (keyFactors.length === 0) keyFactors.push('Multiple Risk Factors');
                        
                        // Create row HTML
                        row.innerHTML = `
                            <td>${patientId}</td>
                            <td>${patientAge}</td>
                            <td>${patientGender}</td>
                            <td><span class="badge bg-danger">High</span></td>
                            <td>${keyFactors.join(', ')}</td>
                            <td>
                                <a href="/patients/${patientId}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-user"></i>
                                </a>
                                <a href="/patients/report/${patientId}" class="btn btn-sm btn-info">
                                    <i class="fas fa-file-medical"></i>
                                </a>
                            </td>
                        `;
                        
                        // Add row to table
                        tableBody.appendChild(row);
                    });
                    
                    console.log('Table manually updated with', patientsToShow.length, 'patients');
                } else {
                    console.warn('API returned empty patients array');
                }
            })
            .catch(error => {
                console.error('Error in direct API test:', error);
            });
    });
    
    function initializeAnalyticalDashboard() {
        try {
            // Risk Distribution Pie Chart
            const riskCtx = document.getElementById('riskDistributionChart');
            if (riskCtx) {
                window.riskDistributionChart = new Chart(riskCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                        datasets: [{
                            data: [54, 42, 28], // Default values
                            backgroundColor: [
                                '#4cc9f0', // Medical blue for low risk
                                '#7209b7', // Medical purple for medium risk
                                '#f72585'  // Medical pink/red for high risk
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverBackgroundColor: [
                                '#3db5db', // Slightly darker on hover
                                '#6508a3', 
                                '#e01e75'
                            ],
                            hoverBorderColor: '#ffffff',
                            hoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        radius: '90%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: 'Poppins, sans-serif',
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    padding: 15,
                                    usePointStyle: true,
                                    boxWidth: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#333',
                                bodyColor: '#333',
                                bodyFont: {
                                    family: 'Poppins, sans-serif'
                                },
                                borderColor: '#ddd',
                                borderWidth: 1,
                                displayColors: true,
                                boxPadding: 8,
                                cornerRadius: 6
                            }
                        }
                    }
                });
            }
            
            // Vital Signs Timeline Chart
            const vitalsCtx = document.getElementById('vitalSignsChart');
            if (vitalsCtx) {
                // Default mock data for the timeline
                const dates = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                const systolicData = [125, 128, 130, 135, 132, 138];
                const diastolicData = [82, 85, 84, 88, 86, 90];
                const heartRateData = [75, 78, 80, 77, 82, 85];
                
                window.vitalSignsChart = new Chart(vitalsCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Systolic BP',
                                data: systolicData,
                                borderColor: '#4e73df',
                                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                                tension: 0.1
                            },
                            {
                                label: 'Diastolic BP',
                                data: diastolicData,
                                borderColor: '#1cc88a',
                                backgroundColor: 'rgba(28, 200, 138, 0.05)',
                                tension: 0.1
                            },
                            {
                                label: 'Heart Rate',
                                data: heartRateData,
                                borderColor: '#e74a3b',
                                backgroundColor: 'rgba(231, 74, 59, 0.05)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
            
            // Lab Results Radar Chart
            const labCtx = document.getElementById('labResultsChart');
            if (labCtx) {
                // Initialize with default values that will be overwritten when data loads
                const labData = [225, 120, 175, 10, 0.05];
                const normalRanges = [200, 100, 150, 5, 0.04];
                
                window.labResultsChart = new Chart(labCtx.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: ['Cholesterol', 'Blood Sugar', 'Triglycerides', 'CK-MB', 'Troponin'],
                        datasets: [{
                            label: 'Current Values',
                            data: labData,
                            backgroundColor: 'rgba(78, 115, 223, 0.2)',
                            borderColor: '#4e73df',
                            pointBackgroundColor: '#4e73df',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#4e73df'
                        }, {
                            label: 'Normal Range',
                            data: normalRanges,
                            backgroundColor: 'rgba(28, 200, 138, 0.2)',
                            borderColor: '#1cc88a',
                            pointBackgroundColor: '#1cc88a',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#1cc88a'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 300,
                                ticks: {
                                    stepSize: 50,
                                    display: true
                                },
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 300
                            }
                        }
                    }
                });
            }
            
            // Patient Metrics Comparison Chart
            const comparisonCtx = document.getElementById('patientComparisonChart');
            if (comparisonCtx) {
                // Default mock data for patient comparison
                const patientData = [28, 138, 90, 220, 110];
                const populationData = [25, 120, 80, 190, 100];
                
                window.patientComparisonChart = new Chart(comparisonCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['BMI', 'Systolic BP', 'Diastolic BP', 'Cholesterol', 'Blood Sugar'],
                        datasets: [{
                            label: 'Selected Patient',
                            data: patientData,
                            backgroundColor: '#4e73df'
                        }, {
                            label: 'Population Average',
                            data: populationData,
                            backgroundColor: '#1cc88a'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error initializing analytical dashboard:', error);
        }
    }
    
    function fetchDashboardData() {
        const dateRange = document.getElementById('date-range-select')?.value || 'week';
        let startDate = null;
        let endDate = null;
        let riskLevel = [];
        
        // Get custom date range if selected
        if (dateRange === 'custom') {
            startDate = document.getElementById('start-date').value;
            endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
        }
        
        // Get selected risk levels
        document.querySelectorAll('input[name="risk-level"]:checked').forEach(checkbox => {
            riskLevel.push(checkbox.value);
        });
        
        console.log('Fetching dashboard data...');
        
        // Build the query parameters
        const params = new URLSearchParams();
        params.append('date_range', dateRange);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (riskLevel.length > 0) {
            riskLevel.forEach(level => params.append('risk_level', level));
        }
        
        // Check if we have sample data passed from the server
        if (sampleData) {
            console.log('Using sample data from server');
            // Use the sample data provided by the route
            updateDashboardData(sampleData);
            
            // Also update high risk table with the patient data from sample data
            if (sampleData.patients && Array.isArray(sampleData.patients)) {
                console.log('Using patients array from sample data');
                updateHighRiskTable(sampleData.patients);
            } else {
                console.log('No patient data in sample data, using empty data structure');
                updateHighRiskTable(getEmptyPatientData());
            }
            return;
        }
        
        // First, fetch dashboard chart data
        console.log('Fetching dashboard data...');
        fetchDashboardChartData()
            .then(chartData => {
                updateDashboardData(chartData);
                
                // Then fetch high-risk patients data separately
                console.log('Fetching high-risk patients data...');
                return fetchHighRiskPatients();
            })
            .then(patientData => {
                if (patientData && Array.isArray(patientData)) {
                    console.log('High-risk patients data fetched successfully:', patientData);
                    updateHighRiskTable(patientData);
                } else {
                    console.warn('No patient data returned, using empty data structure');
                    updateHighRiskTable(getEmptyPatientData());
                }
            })
            .catch(error => {
                console.error('Error in fetch chain:', error);
                // Fallback to mock data
                const mockData = getMockDashboardData();
                updateDashboardData(mockData);
                
                console.log('Updating high risk table with mock data due to error...');
                updateHighRiskTable(getMockPatientData());
            });
    }
    
    // Function to fetch dashboard chart data
    function fetchDashboardChartData() {
        return new Promise((resolve, reject) => {
            // Build the query parameters based on filters
            const dateRange = document.getElementById('date-range-select')?.value || 'week';
            let startDate = null;
            let endDate = null;
            let riskLevel = [];
            
            // Get custom date range if selected
            if (dateRange === 'custom') {
                startDate = document.getElementById('start-date').value;
                endDate = document.getElementById('end-date').value;
            }
            
            // Get selected risk levels
            document.querySelectorAll('input[name="risk-level"]:checked').forEach(checkbox => {
                riskLevel.push(checkbox.value);
            });
            
            // Build the query string
            const params = new URLSearchParams();
            params.append('date_range', dateRange);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (riskLevel.length > 0) {
                riskLevel.forEach(level => params.append('risk_level', level));
            }
            
            // Fetch data from the API
            fetch('/analytical/data?' + params.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dashboard data fetched successfully:', data);
                    resolve(data);
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                    // Fall back to empty data structure if the server request fails
                    console.warn('Falling back to empty data structure due to API error');
                    resolve(getEmptyDashboardData());
                });
        });
    }
    
    // Function to fetch high-risk patients data
    function fetchHighRiskPatients() {
        return new Promise((resolve, reject) => {
            // Build the query parameters
            const params = new URLSearchParams();
            params.append('risk_level', 'High Risk'); // Only get high risk patients
            
            console.log('Fetching high risk patients from API...');
            
            // Fetch data from the API
            fetch('/analytical/patients?' + params.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('High risk patients fetched successfully, count:', data.length);
                    if (data.length === 0) {
                        console.warn('No high risk patients returned from API');
                    } else {
                        console.log('Sample patient data:', data[0]);
                        console.log('patient_id:', data[0].patient_id);
                        console.log('age:', data[0].age);
                        console.log('gender:', data[0].gender);
                    }
                    resolve(data);
                })
                .catch(error => {
                    console.error('Error fetching high risk patients:', error);
                    // Fall back to empty data structure if the server request fails
                    console.warn('Falling back to empty patient data due to API error');
                    resolve(getEmptyPatientData());
                });
        });
    }
    
    function updateDashboardData(data) {
        try {
            console.log('Updating dashboard with data:', data);
            
            // Update risk distribution chart
            if (window.riskDistributionChart) {
                let riskLabels = ['Low Risk', 'Medium Risk', 'High Risk'];
                let riskData = [54, 42, 28]; // Default values
                
                if (data.risk_distribution && Array.isArray(data.risk_distribution)) {
                    // Create a map to aggregate counts by risk level
                    const riskMap = new Map();
                    riskMap.set('Low', 0);  // Initialize with zero counts
                    riskMap.set('Medium', 0);
                    riskMap.set('High', 0);
                    
                    // Process the data and consolidate duplicate risk levels
                    for (const item of data.risk_distribution) {
                        // Skip numeric risk levels or unknown formats
                        if (!isNaN(item.risk_level) || item.risk_level === '0' || item.risk_level === '1' || item.risk_level === '2') {
                            console.log('Skipping numeric risk level:', item.risk_level);
                            continue;
                        }
                        
                        // Normalize risk level text for consistency
                        let normalizedRiskLevel;
                        const riskText = item.risk_level.toLowerCase();
                        
                        if (riskText.includes('high')) {
                            normalizedRiskLevel = 'High';
                        } else if (riskText.includes('medium') || riskText.includes('mid')) {
                            normalizedRiskLevel = 'Medium';
                        } else if (riskText.includes('low')) {
                            normalizedRiskLevel = 'Low';
                        } else {
                            // Skip any other non-standard risk levels
                            console.log('Skipping non-standard risk level:', item.risk_level);
                            continue;
                        }
                        
                        // Add to our map, combining duplicates
                        riskMap.set(normalizedRiskLevel, riskMap.get(normalizedRiskLevel) + item.count);
                    }
                    
                    // Standard risk levels in logical order: Low, Medium, High
                    const standardRiskLevels = ['Low', 'Medium', 'High'];
                    
                    // Create arrays for the chart, using only our standard risk levels
                    riskLabels = standardRiskLevels.map(level => `${level} Risk`);
                    riskData = standardRiskLevels.map(level => riskMap.get(level));
                    
                    console.log('Processed standard risk distribution data:', riskLabels, riskData);
                }
                
                window.riskDistributionChart.data.labels = riskLabels;
                window.riskDistributionChart.data.datasets[0].data = riskData;
                window.riskDistributionChart.update();
                console.log('Risk distribution chart updated');
            } else {
                console.warn('Risk distribution chart not initialized');
            }
            
            // Update vital signs chart
            if (window.vitalSignsChart) {
                // Default values in case database data is not available
                let dates = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                let systolicData = [125, 128, 130, 135, 132, 138];
                let diastolicData = [82, 85, 84, 88, 86, 90];
                let heartRateData = [75, 78, 80, 77, 82, 85];
                
                // Use actual data if available
                if (data.vital_signs_timeline) {
                    console.log('Updating vital signs chart with timeline data');
                    console.log('Dates array?', Array.isArray(data.vital_signs_timeline.dates));
                    console.log('Dates:', data.vital_signs_timeline.dates);
                    
                    // Check if we're using mock data
                    if (data.vital_signs_timeline.is_mock_data === true) {
                        console.warn('WARNING: Using mock vital signs data instead of real database data!');
                        // Add a warning banner above the chart if using mock data
                        const vitalSignsCard = document.getElementById('vitalSignsChart').closest('.card');
                        let warningBanner = vitalSignsCard.querySelector('.mock-data-warning');
                        
                        if (!warningBanner) {
                            warningBanner = document.createElement('div');
                            warningBanner.className = 'mock-data-warning alert alert-warning mb-3';
                            warningBanner.innerHTML = '<strong>Notice:</strong> Using sample data. No matching records found in database.';
                            const cardBody = vitalSignsCard.querySelector('.card-body');
                            cardBody.insertBefore(warningBanner, cardBody.firstChild);
                        }
                    } else {
                        // Remove warning banner if it exists
                        const vitalSignsCard = document.getElementById('vitalSignsChart').closest('.card');
                        const warningBanner = vitalSignsCard.querySelector('.mock-data-warning');
                        if (warningBanner) {
                            warningBanner.remove();
                        }
                        console.log('Using real database data for vital signs timeline');
                    }
                    
                    // Extract data from the response
                    if (Array.isArray(data.vital_signs_timeline.dates) && data.vital_signs_timeline.dates.length > 0) {
                        dates = data.vital_signs_timeline.dates;
                    }
                    
                    if (Array.isArray(data.vital_signs_timeline.systolic) && data.vital_signs_timeline.systolic.length > 0) {
                        systolicData = data.vital_signs_timeline.systolic;
                    }
                    
                    if (Array.isArray(data.vital_signs_timeline.diastolic) && data.vital_signs_timeline.diastolic.length > 0) {
                        diastolicData = data.vital_signs_timeline.diastolic;
                    }
                    
                    if (Array.isArray(data.vital_signs_timeline.heart_rate) && data.vital_signs_timeline.heart_rate.length > 0) {
                        heartRateData = data.vital_signs_timeline.heart_rate;
                    }
                } else {
                    console.warn('No vital signs timeline data available, using default values');
                }
                
                // Update the chart with either real or default data
                window.vitalSignsChart.data.labels = dates;
                window.vitalSignsChart.data.datasets[0].data = systolicData;
                window.vitalSignsChart.data.datasets[1].data = diastolicData;
                window.vitalSignsChart.data.datasets[2].data = heartRateData;
                window.vitalSignsChart.update();
                console.log('Vital signs chart updated');
            } else {
                console.warn('Vital signs chart not initialized');
            }
            
            // Update lab results chart
            if (window.labResultsChart) {
                // Set default values to ensure chart displays properly
                let labLabels = ['Cholesterol', 'Blood Sugar', 'Triglycerides', 'CK-MB', 'Troponin'];
                let labData = [225, 120, 175, 10, 0.05];
                let normalRanges = [200, 100, 150, 5, 0.04];
                
                // Use actual data if available
                if (data.lab_results) {
                    console.log('Updating lab results chart with database data:', data.lab_results);
                    
                    // Update labels if available
                    if (Array.isArray(data.lab_results.labels) && data.lab_results.labels.length > 0) {
                        labLabels = data.lab_results.labels;
                    }
                    
                    // Update current values if available
                    if (Array.isArray(data.lab_results.current_values) && data.lab_results.current_values.length > 0) {
                        labData = data.lab_results.current_values;
                    }
                    
                    // Update normal ranges if available
                    if (Array.isArray(data.lab_results.normal_ranges) && data.lab_results.normal_ranges.length > 0) {
                        normalRanges = data.lab_results.normal_ranges;
                    }
                    
                    // Display patient counts in console for debugging
                    if (data.lab_results.patient_counts) {
                        console.log('Patient counts with abnormal lab results:', data.lab_results.patient_counts);
                    }
                }
                
                // Update chart with the data
                window.labResultsChart.data.labels = labLabels;
                window.labResultsChart.data.datasets[0].data = labData;
                window.labResultsChart.data.datasets[1].data = normalRanges;
                window.labResultsChart.update();
                console.log('Lab results chart updated');
            } else {
                console.warn('Lab results chart not initialized');
            }
            
            // Update comparison chart
            if (window.patientComparisonChart) {
                // Default values if database data is not available
                let chartLabels = ['BMI', 'Systolic BP', 'Diastolic BP', 'Cholesterol', 'Blood Sugar'];
                let chartPatientData = [28, 138, 90, 220, 110];
                let populationData = [25, 120, 80, 190, 100];
                
                // Use actual data if available
                if (data.patient_metrics) {
                    console.log('Updating patient metrics chart with database data:', data.patient_metrics);
                    
                    // Check if we're using mock data
                    if (data.patient_metrics.is_mock_data === true) {
                        console.warn('WARNING: Using mock patient metrics data instead of real database data!');
                        // Add a warning banner above the chart if using mock data
                        const metricsCard = document.getElementById('patientComparisonChart').closest('.card');
                        let warningBanner = metricsCard.querySelector('.mock-data-warning');
                        
                        if (!warningBanner) {
                            warningBanner = document.createElement('div');
                            warningBanner.className = 'mock-data-warning alert alert-warning mb-3';
                            warningBanner.innerHTML = '<strong>Notice:</strong> Using sample data. No matching records found in database.';
                            const cardBody = metricsCard.querySelector('.card-body');
                            cardBody.insertBefore(warningBanner, cardBody.firstChild);
                        }
                    } else {
                        // Remove warning banner if it exists
                        const metricsCard = document.getElementById('patientComparisonChart').closest('.card');
                        const warningBanner = metricsCard.querySelector('.mock-data-warning');
                        if (warningBanner) {
                            warningBanner.remove();
                        }
                        console.log('Using real database data for patient metrics comparison');
                    }
                    
                    // Update labels if available
                    if (Array.isArray(data.patient_metrics.labels) && data.patient_metrics.labels.length > 0) {
                        chartLabels = data.patient_metrics.labels;
                    }
                    
                    // Update patient data if available
                    if (Array.isArray(data.patient_metrics.patient_data) && data.patient_metrics.patient_data.length > 0) {
                        chartPatientData = data.patient_metrics.patient_data;
                    }
                    
                    // Update population data if available
                    if (Array.isArray(data.patient_metrics.population_data) && data.patient_metrics.population_data.length > 0) {
                        populationData = data.patient_metrics.population_data;
                    }
                }
                
                // Update the chart
                window.patientComparisonChart.data.labels = chartLabels;
                window.patientComparisonChart.data.datasets[0].data = chartPatientData;
                window.patientComparisonChart.data.datasets[1].data = populationData;
                window.patientComparisonChart.update();
                console.log('Patient comparison chart updated');
            } else {
                console.warn('Patient comparison chart not initialized');
            }
            
            // We don't update the high risk patients table here anymore
            // That's now handled separately by fetchHighRiskPatients() function
        } catch (error) {
            console.error('Error updating dashboard data:', error);
            alert('There was an error updating the dashboard. Please refresh the page and try again.');
        }
    }
    
    function updateHighRiskTable(patientData, showAll = false) {
        try {
            console.log('Starting to update high risk table with fetched data...');
            const tableBody = document.querySelector('#highRiskTable tbody');
            if (!tableBody) {
                console.error('High risk table body not found');
                return;
            }
            
            // Clear the table first
            tableBody.innerHTML = '';
            
            // Validate the patient data
            if (!patientData || !Array.isArray(patientData) || patientData.length === 0) {
                console.warn('No patient data provided or invalid data format');
                // Show a message in the table
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center">No patient data available</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            console.log('Processing patient data:', patientData.length, 'records');
            
            // Determine high risk patients based on possible database structures
            let highRiskPatients = [];
            
            // All patients from this endpoint should be high risk
            // Just make sure we have data to work with
            highRiskPatients = patientData;
            
            // Debug what we're receiving
            console.log('Patient data sample:', patientData[0]);
            
            console.log('Found high risk patients:', highRiskPatients.length);
            
            // If no high risk patients, show message
            if (highRiskPatients.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center">No high-risk patients found</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // Display all high risk patients or just the first 10 based on the showAll parameter
            const patientsToShow = showAll ? highRiskPatients : highRiskPatients.slice(0, 10);
            
            // Add each patient to the table
            console.log('Processing patients for display:', patientsToShow.length);
            for (const patient of patientsToShow) {
                console.log('Processing patient:', patient);
                const row = document.createElement('tr');
                
                // Get data from the database response
                const patientId = patient.patient_id || 'N/A';
                const patientAge = patient.age || 'N/A';
                const patientGender = patient.gender || 'Unknown';
                
                console.log(`Display values: ID=${patientId}, Age=${patientAge}, Gender=${patientGender}`);
                
                // Get risk score from different possible fields
                let riskScore = 'High';
                if (patient.risk_score) {
                    riskScore = patient.risk_score;
                } else if (patient.score) {
                    riskScore = patient.score;
                }
                
                // Determine key factors based on patient data
                let keyFactors = [];
                
                // Scale the normalized values from database to clinical values
                const scaledSystolicBP = patient.SystolicBP * 90 + 90; // 90-180 mmHg range
                const scaledDiastolicBP = patient.DiastolicBP * 60 + 60; // 60-120 mmHg range
                const scaledBMI = patient.BMI * 30 + 15; // 15-45 range
                const scaledCholesterol = patient.Cholesterol * 150 + 150; // 150-300 mg/dL range
                const scaledBloodSugar = patient.BloodSugar * 100 + 70; // 70-170 mg/dL range
                
                console.log(`Patient ${patientId} scaled values:`, {
                    SystolicBP: scaledSystolicBP,
                    DiastolicBP: scaledDiastolicBP,
                    BMI: scaledBMI,
                    Cholesterol: scaledCholesterol,
                    BloodSugar: scaledBloodSugar
                });
                
                // Smoking, drinking, and other lifestyle factors - scale normalized values
                if (patient.Smoking > 0.5) { // Normalized threshold for smoking
                    keyFactors.push('Smoking');
                }
                if (patient.AlcoholConsumption > 0.6) { // Normalized threshold for high alcohol
                    keyFactors.push('Alcohol');
                }
                // Exercise is normalized 0-1, scale to 0-10 hours/week
                const scaledExercise = patient.ExerciseHoursPerWeek * 10;
                if (scaledExercise < 2) {
                    keyFactors.push('Low Exercise');
                }
                // Sleep is normalized 0-1, scale to 4-10 hours/day
                const scaledSleep = patient.SleepHoursPerDay * 6 + 4;
                if (scaledSleep < 6) {
                    keyFactors.push('Sleep Issues');
                }
                
                // Check vitals using the scaled values
                if (scaledSystolicBP > 140 || scaledDiastolicBP > 90) {
                    keyFactors.push('High BP');
                }
                if (scaledBMI > 30) {
                    keyFactors.push('Obesity');
                }
                if (scaledCholesterol > 200) {
                    keyFactors.push('Cholesterol');
                }
                if (scaledBloodSugar > 120) {
                    keyFactors.push('Blood Sugar');
                }
                
                if (patient.ExerciseHoursPerWeek < 2) keyFactors.push('Low Exercise');
                if (patient.SleepHoursPerDay < 6) keyFactors.push('Sleep Deficit');
                
                // Check medical history - direct from SQL query
                if (patient.Diabetes === 1) keyFactors.push('Diabetes');
                if (patient.FamilyHistory === 1) keyFactors.push('Family History');
                if (patient.PreviousHeartProblems === 1) keyFactors.push('Previous Heart Issues');
                
                // Use a default if no factors identified
                if (keyFactors.length === 0) {
                    keyFactors.push('Multiple Risk Factors');
                }
                
                // Take top 3 factors for display
                let keyFactorsText = keyFactors.slice(0, 3).join(', ');
                
                // Debug the row before adding it
                console.log('Adding row with data:', {
                    patientId: patientId,
                    age: patientAge,
                    gender: patientGender,
                    keyFactors: keyFactorsText
                });

                // Create the HTML for the row
                row.innerHTML = `
                    <td>${patientId}</td>
                    <td>${patientAge}</td>
                    <td>${patientGender}</td>
                    <td><span class="badge bg-danger">High</span></td>
                    <td>${keyFactorsText}</td>
                    <td>
                        <a href="/patients/${patientId}" class="btn btn-sm btn-primary">
                            <i class="fas fa-user"></i>
                        </a>
                        <a href="/patients/report/${patientId}" class="btn btn-sm btn-info">
                            <i class="fas fa-file-medical"></i>
                        </a>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            console.log('High risk table updated with', patientsToShow.length, 'patients');
        } catch (error) {
            console.error('Error updating high risk table:', error);
            // Handle error in UI
            const tableBody = document.querySelector('#highRiskTable tbody');
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error loading patient data</td></tr>`;
            }
        }
    }
    
    function searchPatient() {
        const patientId = document.getElementById('patient-search').value;
        if (patientId) {
            // Redirect to patient detail page if ID entered
            window.location.href = `/patients/${patientId}`;
        } else {
            // Show error message
            alert('Please enter a Patient ID');
        }
    }
    
    function downloadChart(chartId, title) {
        const canvas = document.getElementById(chartId);
        const image = canvas.toDataURL('image/png');
        
        const link = document.createElement('a');
        link.download = `${title.replace(/\s+/g, '_').toLowerCase()}.png`;
        link.href = image;
        link.click();
    }
    
    function downloadSVG(svgId, title) {
        const svg = document.getElementById(svgId).querySelector('svg');
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svg);
        
        source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
        const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
        
        const link = document.createElement('a');
        link.download = `${title.replace(/\s+/g, '_').toLowerCase()}.svg`;
        link.href = url;
        link.click();
    }
    
    // Empty fallback data structures in case API calls fail
    function getEmptyDashboardData() {
        return {
            risk_distribution: [],
            metrics: {
                avg_risk_score: 0,
                vital_stats: {
                    avg_bmi: 0,
                    avg_systolic: 0,
                    avg_diastolic: 0,
                    avg_heart_rate: 0
                },
                lab_stats: {
                    avg_cholesterol: 0,
                    avg_blood_sugar: 0
                }
            },
            patient_data: []
        };
    }
    
    function getEmptyPatientData() {
        // Return a minimal placeholder array with one item for display purposes
        return [{
            patient_id: 'N/A',
            name: 'Loading...',
            age: '-',
            risk_score: '-',
            risk_level: 'unknown',
            key_factors: 'Fetching data...',
            HeartAttackRiskText: 'unknown'
        }];
    }


    // Initialize circular charts using Chart.js
    function initializeCircularCharts() {
        // Simple configuration options for all charts
        const commonOptions = {
            cutout: '75%',
            plugins: {
                tooltip: { enabled: false },
                legend: { display: false }
            },
            responsive: true,
            maintainAspectRatio: false
        };
        
        // Total Patients Chart (Blue)
        try {
            const totalCtx = document.getElementById('totalPatientsChart');
            if (totalCtx) {
                new Chart(totalCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [100, 0], // 100% full
                            backgroundColor: ['#4361ee', '#e9efff'],
                            borderWidth: 0
                        }]
                    },
                    options: commonOptions
                });
            }
        } catch (e) {
            console.error('Error initializing total patients chart:', e);
        }
        
        // High Risk Patients Chart (Red)
        try {
            const highRiskCtx = document.getElementById('highRiskChart');
            if (highRiskCtx) {
                new Chart(highRiskCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [14, 86], // 14% of total
                            backgroundColor: ['#ef4444', '#fff5f5'],
                            borderWidth: 0
                        }]
                    },
                    options: commonOptions
                });
            }
        } catch (e) {
            console.error('Error initializing high risk chart:', e);
        }
        
        // Medium Risk Patients Chart (Yellow)
        try {
            const mediumRiskCtx = document.getElementById('mediumRiskChart');
            if (mediumRiskCtx) {
                new Chart(mediumRiskCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [23, 77], // 23% of total
                            backgroundColor: ['#f59e0b', '#fffbeb'],
                            borderWidth: 0
                        }]
                    },
                    options: commonOptions
                });
            }
        } catch (e) {
            console.error('Error initializing medium risk chart:', e);
        }
        
        // Low Risk Patients Chart (Green)
        try {
            const lowRiskCtx = document.getElementById('lowRiskChart');
            if (lowRiskCtx) {
                new Chart(lowRiskCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [63, 37], // 63% of total
                            backgroundColor: ['#10b981', '#ecfdf5'],
                            borderWidth: 0
                        }]
                    },
                    options: commonOptions
                });
            }
        } catch (e) {
            console.error('Error initializing low risk chart:', e);
        }
    }
</script>
{% endblock %}
